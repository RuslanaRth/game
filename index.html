<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Ken — test levels</title>
<style>
  html,body {height:100%; margin:0; background:#000;}
  #gameCanvas {
    display:block; 
    width: 100vw;
    height: 100vh;
    background:#222;
  }
  #overlay {position:fixed; left:10px; top:10px; color:#fff; font-family: monospace; background:rgba(0,0,0,0.6); padding:6px; border-radius:6px;}
  #errors {position:fixed; right:10px; top:10px; color:#fff; font-family:monospace; background:rgba(128,0,0,0.6); padding:6px; border-radius:6px; display:none;}
  #oopsButton {
    display:none;
    position:fixed;
    left:50%;
    bottom:50px;
    transform:translateX(-50%);
    padding:12px 24px;
    font-size:18px;
    font-family:monospace;
    background:#ff4444;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
  }
  canvas.confetti {
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    pointer-events:none;
  }
</style>
</head>
<body>
<canvas id="gameCanvas" width="900" height="500"></canvas>
<div id="overlay">Загрузка ресурсов...</div>
<div id="errors"></div>
<button id="oopsButton">Oops!</button>
<canvas id="confettiCanvas" class="confetti"></canvas>

<script>
/* ------------- Настройки и список файлов ------------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const errorsBox = document.getElementById('errors');
const oopsButton = document.getElementById('oopsButton');
const confettiCanvas = document.getElementById('confettiCanvas');
const confettiCtx = confettiCanvas.getContext('2d');
confettiCanvas.width = window.innerWidth;
confettiCanvas.height = window.innerHeight;

const IMAGES = {
  back1: 'back1.jpg',
  back2: 'back2.jpg',
  back3: 'back3.jpg',
  back4: 'back4.jpg',
  idle: 'idle.png',
  idle2: 'idle2.png',
  walk1: 'walk1.png',
  walk2: 'walk2.png',
  punch: 'punch.png',
  mushidle1: 'mushidle1.png',
  mushidle2: 'mushidle2.png',
  mushpunch: 'mushpunch.png',
  mushdeath: 'mushdeath.png',
  girl1: 'girl1.png',
  girl2: 'girl2.png',
  girl3: 'girl3.png',
  oops: 'oops.jpg',
  oops2: 'oops2.jpg'
};

const SOUNDS = {
  fail: new Audio('fail.mp3'),
  kitty: new Audio('kitty.mp3')
};

/* ------------- Загрузка ------------- */
let images = {};
let missing = [];

function loadImage(key, src) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => { images[key] = img; resolve({ok:true,key}); };
    img.onerror = () => { missing.push(src); images[key] = null; resolve({ok:false,key}); };
    img.src = src;
  });
}

async function preloadAll() {
  overlay.textContent = 'Загружаю ресурсы...';
  const promises = Object.entries(IMAGES).map(([k,s]) => loadImage(k,s));
  await Promise.all(promises);
  if (missing.length) {
    errorsBox.style.display = 'block';
    errorsBox.textContent = 'Не загружены: ' + missing.join(', ');
  } else {
    errorsBox.style.display = 'none';
  }
  overlay.textContent = 'Стрелки ← → — движение, Space — удар/действие.';
}

/* ------------- Игровые сущности ------------- */
let page = 1;
let showOops = false;
let showOops2 = false;

const ken = {
  x: 50, y: canvas.height - 200, w: 200, h: 200,
  vx: 5,
  action: 'idle', frame:0, animTimer:0,
  facing: 'right'
};

const enemies = {
  level2: {
    x: 600, y: canvas.height - 200, w: 200, h: 200,
    hp: 5, alive: true, action:'idle', frame:0, animTimer:0,
    hitTimer: 0
  },
  level3: [
    {x:400,y:canvas.height-200,w:200,h:200,hp:5,alive:true,action:'idle',frame:0,animTimer:0,hitTimer:0},
    {x:700,y:canvas.height-200,w:200,h:200,hp:5,alive:true,action:'idle',frame:0,animTimer:0,hitTimer:0}
  ]
};

/* ------------- Управление ------------- */
const keys = {};
window.addEventListener('keydown', e => {
  keys[e.code] = true;
  if (e.code === 'Space') e.preventDefault();
});
window.addEventListener('keyup', e => { keys[e.code] = false; });
  /* ------------- Вспомогательные функции ------------- */
function isColliding(a, b) {
  return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
}

/* ------------- Отрисовка персонажей ------------- */
function drawKen() {
  const imgSet = (ken.action === 'walk') ? [images.walk1, images.walk2]
                : (ken.action === 'punch') ? [images.punch]
                : [images.idle, images.idle2];

  ken.animTimer++;
  if (ken.animTimer > 10) { ken.animTimer = 0; ken.frame = (ken.frame+1) % imgSet.length; }

  const img = imgSet[ken.frame];
  if (img) {
    ctx.save();
    if (ken.facing === 'left') {
      ctx.scale(-1, 1);
      ctx.drawImage(img, -ken.x - ken.w, ken.y, ken.w, ken.h);
    } else {
      ctx.drawImage(img, ken.x, ken.y, ken.w, ken.h);
    }
    ctx.restore();
  }
}

function drawEnemy(enemy) {
  if (!enemy.alive) return;
  const imgSet = (enemy.action === 'punch') ? [images.mushpunch] : [images.mushidle1, images.mushidle2];
  enemy.animTimer++;
  if (enemy.animTimer > 12) { enemy.animTimer = 0; enemy.frame = (enemy.frame+1) % imgSet.length; }
  const img = imgSet[enemy.frame];
  if (img) ctx.drawImage(img, enemy.x, enemy.y, enemy.w, enemy.h);
}

function drawGirl() {
  const frames = [images.girl1, images.girl2, images.girl3];
  const frame = Math.floor(Date.now()/400) % frames.length;
  const img = frames[frame];
  if (img) ctx.drawImage(img, canvas.width-200, canvas.height-300, 180, 280);
}

/* ------------- Конфетти ------------- */
let confetti = [];
function startConfetti() {
  confetti = Array.from({length:150}, () => ({
    x: Math.random()*confettiCanvas.width,
    y: Math.random()*confettiCanvas.height,
    r: Math.random()*6+4,
    d: Math.random()*50,
    color: "hsl(" + Math.random()*360 + ",100%,50%)",
    tilt: Math.random()*10-10
  }));
}
function drawConfetti() {
  confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  confetti.forEach(c => {
    confettiCtx.beginPath();
    confettiCtx.fillStyle = c.color;
    confettiCtx.arc(c.x,c.y,c.r,0,Math.PI*2,true);
    confettiCtx.fill();
  });
}
function updateConfetti() {
  confetti.forEach(c => {
    c.y += Math.cos(c.d) + 2 + c.r/2;
    c.x += Math.sin(c.d);
    if (c.y > confettiCanvas.height) {
      c.y = -10; c.x = Math.random()*confettiCanvas.width;
    }
  });
  drawConfetti();
}

/* ------------- Логика обновления ------------- */
function update() {
  if (page<4 && !showOops) {
    if (keys['ArrowRight']) { ken.x+=ken.vx; ken.action='walk'; ken.facing='right'; }
    else if (keys['ArrowLeft']) { ken.x-=ken.vx; ken.action='walk'; ken.facing='left'; }
    else { if (ken.action!=='punch') ken.action='idle'; }
  }

  ken.x = Math.max(0, Math.min(canvas.width-ken.w, ken.x));

  if (keys['Space']) {
    if (page===4 && !showOops) {
      if (ken.x > canvas.width-300) {
        showOops = true;
        SOUNDS.fail.play();
        oopsButton.style.display='block';
      }
    }
    keys['Space']=false;
  }

  if (page===1 && ken.x>=canvas.width-ken.w-10) { page=2; ken.x=40; }
  if (page===2 && ken.x>=canvas.width-ken.w-10 && !enemies.level2.alive) { page=3; ken.x=40; }
  if (page===3 && ken.x>=canvas.width-ken.w-10) { page=4; ken.x=40; }
}

/* ------------- Отрисовка сцены ------------- */
function render() {
  const bg = (page===1)?images.back1:(page===2)?images.back2:(page===3)?images.back3:images.back4;
  if (bg) ctx.drawImage(bg,0,0,canvas.width,canvas.height);
  else { ctx.fillStyle='#333'; ctx.fillRect(0,0,canvas.width,canvas.height); }

  if (page===2 && enemies.level2.alive) drawEnemy(enemies.level2);
  if (page===3) enemies.level3.forEach(e=>{if(e.alive) drawEnemy(e);});

  if (page===4) drawGirl();

  drawKen();

  ctx.fillStyle='#fff';
  ctx.font='16px monospace';
  ctx.fillText('Уровень: '+page,12,26);

  if (page===4 && !showOops && ken.x>canvas.width-300) {
    ctx.fillStyle='yellow';
    ctx.font='20px monospace';
    ctx.fillText('Нажми A (Space)',canvas.width-220,canvas.height-320);
  }
  if (showOops) {
    if (images.oops) ctx.drawImage(images.oops,canvas.width/2-200,canvas.height/2-150,400,300);
  }
  if (showOops2) {
    if (images.oops2) ctx.drawImage(images.oops2,canvas.width/2-200,canvas.height/2-150,400,300);
  }
}

/* ------------- Игровой цикл ------------- */
function loop() {
  update();
  render();
  if (showOops2) updateConfetti();
  requestAnimationFrame(loop);
}

/* ------------- Обработчики кнопок ------------- */
oopsButton.addEventListener('click',()=>{
  showOops=false;
  showOops2=true;
  oopsButton.style.display='none';
  SOUNDS.kitty.play();
  startConfetti();
});

/* ------------- Старт ------------- */
preloadAll().then(()=>{ overlay.style.display='none'; loop(); });
</script>
</body>
</html>

