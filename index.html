<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ken — сюжет</title>
<style>
  html,body{height:100%;margin:0;background:#000;font-family:monospace;}
  canvas{display:block;width:100vw;height:100vh;}
  #overlay{position:fixed;left:10px;top:10px;color:#fff;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;z-index:9999;}
  #oopsBtn{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:60px;padding:12px 18px;background:#e33;color:#fff;border-radius:8px;border:0;cursor:pointer;z-index:10000;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="overlay">Загрузка ресурсов...</div>
<button id="oopsBtn">Oops!</button>

<script>
let images = {};
let SOUNDS = {};
let missing = [];
let page = 1;
let showOops = false, showOops2 = false;

// главный герой
const ken = {x:50,y:0,w:200,h:200,vx:6,action:'idle',frame:0,animTimer:0,facing:'right'};

// враги
const enemies = {
  level2: {x:0,y:0,w:200,h:200,hp:5,alive:true,animTimer:0,action:'idle',hitTimer:0},
  level3: [
    {x:0,y:0,w:200,h:200,hp:5,alive:true,animTimer:0,action:'idle',hitTimer:0},
    {x:0,y:0,w:200,h:200,hp:5,alive:true,animTimer:0,action:'idle',hitTimer:0}
  ]
};

// девушка
const girl = {x:0,y:0,w:220,h:200};

// ================= БАЗА =================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const oopsBtn = document.getElementById("oopsBtn");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  placeEntities();
}
window.addEventListener("resize",resize);
resize();

function placeEntities(){
  const ground = canvas.height - 200 - 20; // нижняя линия
  ken.y = ground;
  enemies.level2.x = canvas.width - 400; enemies.level2.y = ground;
  enemies.level3[0].x = canvas.width - 600; enemies.level3[0].y = ground;
  enemies.level3[1].x = canvas.width - 300; enemies.level3[1].y = ground;
  girl.x = canvas.width - 280; girl.y = ground;
}

function isColliding(a,b){
  return !(a.x+a.w<b.xa.x>b.x+b.wa.y+a.h<b.y||a.y>b.y+b.h);
}

function drawPlaceholder(x,y,w,h,label){
  ctx.fillStyle="#222";ctx.fillRect(x,y,w,h);
  ctx.strokeStyle="#555";ctx.strokeRect(x+1,y+1,w-2,h-2);
  ctx.fillStyle="#fff";ctx.font="14px monospace";ctx.fillText(label,x+6,y+18);
}

// ================= ОТРИСОВКА =================
function drawKen(){
  let set=[images.idle,images.idle1].filter(Boolean);
  let walk=[images.walk1,images.walk2].filter(Boolean);
  let img=null;
  if(ken.action==="walk"&&walk.length){img=walk[Math.floor(ken.animTimer/10)%walk.length];}
  else if(ken.action==="punch"&&images.punch){img=images.punch;}
  else if(set.length){img=set[Math.floor(ken.animTimer/20)%set.length];}
  if(!img){drawPlaceholder(ken.x,ken.y,ken.w,ken.h,"Ken");return;}
  ctx.save();
  if(ken.facing==="left"){ctx.scale(-1,1);ctx.drawImage(img,-ken.x-ken.w,ken.y,ken.w,ken.h);}
  else{ctx.drawImage(img,ken.x,ken.y,ken.w,ken.h);}
  ctx.restore();
}

function drawEnemy(en){
  if(!en.alive) return;
  let set=[images.mushidle1,images.mushidle2].filter(Boolean);
  if(en.action==="punch"&&images.mushpunch) set=[images.mushpunch];
  if(set.length===0){drawPlaceholder(en.x,en.y,en.w,en.h,"Mush");return;}
  let img=set[Math.floor(en.animTimer/12)%set.length];
  ctx.drawImage(img,en.x,en.y,en.w,en.h);
}

function drawDeathPuffs(){
  if(!enemies.level2.alive&&images.mushdeath)
    ctx.drawImage(images.mushdeath,enemies.level2.x,enemies.level2.y,enemies.level2.w,enemies.level2.h);
  enemies.level3.forEach(en=>{
    if(!en.alive&&images.mushdeath)
      ctx.drawImage(images.mushdeath,en.x,en.y,en.w,en.h);
  });
}

function drawGirl(){
  const frames=[images.girl1,images.girl2,images.girl3].filter(Boolean);
  if(frames.length===0){drawPlaceholder(girl.x,girl.y,girl.w,girl.h,"Girl");return;}
  let img=frames[Math.floor(Date.now()/400)%frames.length];
  ctx.drawImage(img,girl.x,girl.y,girl.w,girl.h);
}
  // ================= РЕСУРСЫ =================
const IMAGES={
  back1:"back1.jpg",back2:"back2.jpg",back3:"back3.jpg",back4:"back4.jpg",
  idle:"idle.png",idle1:"idle1.png",walk1:"walk1.png",walk2:"walk2.png",punch:"punch.png",
  mushidle1:"mushidle1.png",mushidle2:"mushidle2.png",mushpunch:"mushpunch.png",mushdeath:"mushdeath.png",
  girl1:"girl1.png",girl2:"girl2.png",girl3:"girl3.png",
  oops:"oops.jpg",oops2:"oops2.jpg"
};
function loadImage(k,src){
  return new Promise(res=>{let img=new Image();img.onload=()=>{images[k]=img;res();};img.onerror=()=>{images[k]=null;res();};img.src=src;});
}
function loadSound(k,src){
  return new Promise(res=>{let a=new Audio();a.oncanplaythrough=()=>{SOUNDS[k]=a;res();};a.onerror=()=>{SOUNDS[k]=null;res();};a.src=src;});
}
async function preloadAll(){
  overlay.textContent="Загружаю ресурсы...";
  let promises=[...Object.entries(IMAGES).map(([k,s])=>loadImage(k,s)),
    loadSound("fail","fail.mp3"),
    loadSound("kitty","kitty.mp3"),
    loadSound("hit","hit.mp3"),
    loadSound("whiff","whiff.mp3")];
  await Promise.all(promises);
  overlay.style.display="none";
}

// ================= УПРАВЛЕНИЕ =================
const keys={};
window.addEventListener("keydown",e=>{
  if(e.code==="Space"){e.preventDefault();keys["Space"]=true;handleAction();}
  if(e.code==="ArrowLeft"||e.code==="ArrowRight") keys[e.code]=true;
});
window.addEventListener("keyup",e=>{
  if(e.code==="Space") keys["Space"]=false;
  if(e.code==="ArrowLeft"||e.code==="ArrowRight") keys[e.code]=false;
});

function playSound(name){
  if(!SOUNDS[name]) return;
  let a=SOUNDS[name].cloneNode();a.play().catch(()=>{});
}

function nearGirl(){
  return isColliding(ken,girl);
}

function handleAction(){
  if(showOops||showOops2) return;
  if(page===4&&nearGirl()){ // событие с девушкой
    showOops=true;
    playSound("fail");
    oopsBtn.style.display="block";
    return;
  }
  // обычный удар
  ken.action="punch";
  let hit=false;
  if(page===2&&enemies.level2.alive&&isColliding(ken,enemies.level2)){
    enemies.level2.hp--;hit=true;enemies.level2.action="punch";enemies.level2.hitTimer=15;
    if(enemies.level2.hp<=0) enemies.level2.alive=false;
  }
  if(page===3){
    enemies.level3.forEach(en=>{
      if(en.alive&&isColliding(ken,en)){
        en.hp--;hit=true;en.action="punch";en.hitTimer=15;
        if(en.hp<=0) en.alive=false;
      }
    });
  }
  playSound(hit?"hit":"whiff");
  setTimeout(()=>{if(ken.action==="punch") ken.action="idle";},250);
}

// ================= ОБНОВЛЕНИЕ =================
function update(){
  if(!showOops&&!showOops2){
    if(keys["ArrowRight"]){ken.x+=ken.vx;ken.action="walk";ken.facing="right";}
    else if(keys["ArrowLeft"]){ken.x-=ken.vx;ken.action="walk";ken.facing="left";}
    else if(ken.action!=="punch") ken.action="idle";
  }
  ken.x=Math.max(0,Math.min(canvas.width-ken.w,ken.x));
  ken.animTimer++;
  if(page===1&&ken.x>=canvas.width-ken.w-10){page=2;ken.x=40;}
  else if(page===2&&ken.x>=canvas.width-ken.w-10&&!enemies.level2.alive){page=3;ken.x=40;}
  else if(page===3&&ken.x>=canvas.width-ken.w-10){page=4;ken.x=40;}
  if(enemies.level2.hitTimer>0){enemies.level2.hitTimer--;if(enemies.level2.hitTimer===0) enemies.level2.action="idle";}
  enemies.level3.forEach(en=>{if(en.hitTimer>0){en.hitTimer--;if(en.hitTimer===0) en.action="idle";}});
}

function render(){
  const bg=(page===1)?images.back1:(page===2)?images.back2:(page===3)?images.back3:images.back4;
  if(bg) ctx.drawImage(bg,0,0,canvas.width,canvas.height);
  else {ctx.fillStyle="#111";ctx.fillRect(0,0,canvas.width,canvas.height);}
  // прах (сзади)
  drawDeathPuffs();
  if(page===2) drawEnemy(enemies.level2);
  if(page===3) enemies.level3.forEach(drawEnemy);
  if(page===4) drawGirl();
  drawKen();
  ctx.fillStyle="#fff";ctx.fillText("Уровень: "+page,14,30);
  if(page===4&&!showOops&&!showOops2&&nearGirl()){
    ctx.fillStyle="yellow";ctx.fillText("Нажми A",canvas.width-300,canvas.height-260);
  }
  if(showOops){
    if(images.oops) ctx.drawImage(images.oops,0,0,canvas.width,canvas.height);
    else drawPlaceholder(100,100,400,300,"oops");
  }
  if(showOops2){
    if(images.oops2) ctx.drawImage(images.oops2,0,0,canvas.width,canvas.height);
    else drawPlaceholder(100,100,400,300,"oops2");
  }
}

oopsBtn.addEventListener("click",()=>{
  showOops=false;showOops2=true;oopsBtn.style.display="none";playSound("kitty");
});

// ================= ЦИКЛ =================
function loop(){update();render();requestAnimationFrame(loop);}
preloadAll().then(()=>{placeEntities();loop();});
</script>
</body>
</html>
