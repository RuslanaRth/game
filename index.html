<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ken — сюжет (retro fixed)</title>
<style>
  html,body{height:100%;margin:0;background:#000;font-family:monospace;}
  canvas{display:block;width:100vw;height:100vh;}
  #overlay{position:fixed;left:10px;top:10px;color:#fff;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;z-index:9999;}
  #oopsBtn{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:60px;padding:12px 18px;background:#e33;color:#fff;border-radius:8px;border:0;cursor:pointer;z-index:10000;}
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="overlay">Загрузка ресурсов... (кликни или нажми любую клавишу, чтобы включить звук)</div>
<button id="oopsBtn">Oops!</button>

<script src="https://cdn.jsdelivr.net/gh/mneubrand/jsfxr/jsfxr.js"></script>
<script>
/* ---------- данные и стейт ---------- */
let images = {}, SOUNDS = {}, missing = [];
let page = 1;
let showOops = false, showOops2 = false;

const ken = { x:50, y:0, w:200, h:200, vx:6, action:'idle', animTimer:0, facing:'right' };
const enemies = {
  level2: { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 },
  level3: [
    { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 },
    { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 }
  ]
};
const girl = { x:0, y:0, w:200, h:200 };

/* ---------- canvas ---------- */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const oopsBtn = document.getElementById('oopsBtn');

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  placeEntities();
}
window.addEventListener('resize', resize);
resize();

function placeEntities(){
  const ground = canvas.height - ken.h - 5; // опускаем чуть ниже
  ken.y = ground;
  enemies.level2.x = Math.max(300, canvas.width - 400); enemies.level2.y = ground;
  enemies.level3[0].x = Math.max(200, canvas.width - 800); enemies.level3[0].y = ground;
  enemies.level3[1].x = Math.max(300, canvas.width - 400); enemies.level3[1].y = ground;
  girl.x = canvas.width - 280; girl.y = ground;
}

function isColliding(a, b){
  return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);
}

function drawPlaceholder(x,y,w,h,label){
  ctx.fillStyle='#222'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='#555'; ctx.strokeRect(x+1,y+1,w-2,h-2);
  ctx.fillStyle='#fff'; ctx.font='14px monospace'; ctx.fillText(label, x+6, y+18);
}

/* ---------- отрисовка ---------- */
function drawKen(){ drawPlaceholder(ken.x, ken.y, ken.w, ken.h, 'Ken'); }
function drawEnemy(en){ if(en.alive) drawPlaceholder(en.x, en.y, en.w, en.h, 'Mush'); }
function drawDeathPuffs(){
  if(page!==4){ // убираем прахи на 4 сцене
    if(!enemies.level2.alive) drawPlaceholder(enemies.level2.x,enemies.level2.y,enemies.level2.w,enemies.level2.h,'Dust');
    enemies.level3.forEach(en=>{ if(!en.alive) drawPlaceholder(en.x,en.y,en.w,en.h,'Dust'); });
  }
}
function drawGirl(){ drawPlaceholder(girl.x, girl.y, girl.w, girl.h, 'Girl'); }

/* ---------- ретро-звуки через jsfxr ---------- */
function genSound(params){ return new Audio(jsfxr(params)); }
function initSounds(){
  SOUNDS = {
    whiff: genSound([0,,0.18,,0.14,0.27,,,,,,,,,0.3,,,,,0.7,,,0.2,,0.3]),
    hit: genSound([0,,0.07,0.23,0.22,0.47,0.1,-0.46,,,,,,,,,0.26,,0.49,0.02,0.42,0.13,0.18]),
    death: genSound([1,,0.27,0.57,0.37,0.26,,-0.58,,,,,0.25,0.52,,,,,,0.76,,,0.27,0.17]),
    fail: genSound([2,,0.25,,0.26,0.45,,0.3,,,,,,,,0.42,,,1,,,0.2,,0.3]),
    kitty: genSound([0,,0.3,,0.3,0.4,,0.3,,,,,,0.2,,,,,1,,,0.3,,0.2])
  };
}
function playSound(name){ if(SOUNDS[name]) SOUNDS[name].cloneNode().play(); }

/* ---------- ввод ---------- */
const keys = {};
let lastPunchTime = 0;
const punchCooldown = 180;
  window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){
    e.preventDefault(); if(e.repeat) return;
    keys['Space'] = true; handleAction(); return;
  }
  if(e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys[e.code] = true;
});
window.addEventListener('keyup', (e)=>{ if(e.code==='Space') keys['Space']=false; if(e.code==='ArrowLeft'||e.code==='ArrowRight') keys[e.code]=false; });

/* ---------- логика ---------- */
function nearGirl(){ return isColliding(ken, girl); }
function attackHitbox(){
  return { x:ken.facing==='right'?ken.x+ken.w-30:ken.x-60, y:ken.y+20, w:90, h:ken.h-40 };
}

function handleAction(){
  if(showOops||showOops2) return;
  if(Date.now()-lastPunchTime<punchCooldown) return;
  lastPunchTime=Date.now();

  if(page===4 && nearGirl()){ showOops=true; playSound('fail'); oopsBtn.style.display='block'; return; }

  let hit=false;
  if(page===2 && enemies.level2.alive && isColliding(attackHitbox(), enemies.level2)){
    enemies.level2.hp--; hit=true; if(enemies.level2.hp<=0){ enemies.level2.alive=false; playSound('death'); }
  }
  if(page===3){
    for(const en of enemies.level3){
      if(en.alive && isColliding(attackHitbox(), en)){
        en.hp--; hit=true; if(en.hp<=0){ en.alive=false; playSound('death'); }
      }
    }
  }
  playSound(hit?'hit':'whiff');
}

/* ---------- кнопка oops ---------- */
oopsBtn.addEventListener('click',()=>{ showOops=false; showOops2=true; oopsBtn.style.display='none'; playSound('kitty'); });

/* ---------- цикл ---------- */
function update(){
  if(!showOops && !showOops2){
    if(keys['ArrowRight']){ ken.x+=ken.vx; ken.facing='right'; }
    else if(keys['ArrowLeft']){ ken.x-=ken.vx; ken.facing='left'; }
  }
  ken.x=Math.max(0,Math.min(canvas.width-ken.w,ken.x));
  if(page===1&&ken.x>=canvas.width-ken.w-10){page=2;ken.x=40;}
  else if(page===2&&ken.x>=canvas.width-ken.w-10&&!enemies.level2.alive){page=3;ken.x=40;}
  else if(page===3&&ken.x>=canvas.width-ken.w-10){page=4;ken.x=40; enemies.level3.forEach(e=>e.alive=false);} // сброс врагов
}

function render(){
  ctx.fillStyle='#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
  drawDeathPuffs();
  if(page===2) drawEnemy(enemies.level2);
  if(page===3) enemies.level3.forEach(drawEnemy);
  if(page===4) drawGirl();
  drawKen();

  ctx.fillStyle='#fff'; ctx.fillText('Уровень: '+page,14,30);

  if(page===4&&!showOops&&!showOops2&&nearGirl()){ ctx.fillStyle='yellow'; ctx.fillText('Нажми A', canvas.width-300, canvas.height-260); }
  if(showOops) drawPlaceholder(canvas.width/2-200,canvas.height/2-150,400,300,'oops');
  if(showOops2) drawPlaceholder(canvas.width/2-180,canvas.height/2-150,360,300,'oops2'); // уменьшено
}

function loop(){ update(); render(); requestAnimationFrame(loop); }

/* ---------- старт ---------- */
initSounds();
loop();
</script>
</body>
</html>
