<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#000000"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Ken Game">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Ken ‚Äî —Å—é–∂–µ—Ç (Mobile)</title>
<style>
  html,body{height:100%;margin:0;background:#000;font-family:monospace;touch-action:none;}
  canvas{display:block;width:100vw;height:100vh;}
  #overlay{position:fixed;left:10px;top:10px;color:#fff;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;z-index:9999;}
  #oopsBtn{display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:60px;padding:12px 18px;background:#e33;color:#fff;border-radius:8px;border:0;cursor:pointer;z-index:10000;}
  
  /* –ú–û–ë–ò–õ–¨–ù–´–ï –ö–ù–û–ü–ö–ò */
  #mobileControls {
    position: fixed;
    bottom: 20px;
    width: 100%;
    display: none;
    justify-content: space-between;
    padding: 0 20px;
    box-sizing: border-box;
    z-index: 1000;
  }
  
  .control-group {
    display: flex;
    gap: 15px;
  }
  
  .control-btn {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.3);
    border: 2px solid #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    user-select: none;
    touch-action: none;
  }
  
  .control-btn:active {
    background: rgba(255,255,255,0.5);
  }
  
  #attackBtn {
    background: rgba(255,50,50,0.6);
    width: 70px;
    height: 70px;
  }
  
  #attackBtn:active {
    background: rgba(255,50,50,0.8);
  }
  
  /* –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –£–°–¢–ê–ù–û–í–ö–ò */
  #installPrompt {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,100,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    display: none;
    z-index: 10000;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="overlay">–ó–∞–≥—Ä—É–∑–∫–∞... (–ö–æ—Å–Ω–∏—Å—å —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –∑–≤—É–∫–∞)</div>
<button id="oopsBtn">Oops!</button>

<!-- –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï -->
<div id="mobileControls">
  <div class="control-group">
    <div class="control-btn" id="leftBtn">‚Üê</div>
    <div class="control-btn" id="rightBtn">‚Üí</div>
  </div>
  <div class="control-group">
    <div class="control-btn" id="attackBtn">‚ö°</div>
  </div>
</div>

<!-- –ü–û–î–°–ö–ê–ó–ö–ê –î–õ–Ø –£–°–¢–ê–ù–û–í–ö–ò -->
<div id="installPrompt">üì≤ –ù–∞–∂–º–∏ "‚ãÆ" ‚Üí "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</div>

<script>
// ===== PWA MANIFEST =====
const manifest = {
  "name": "Ken Game",
  "short_name": "Ken",
  "description": "–£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–∞—è –∏–≥—Ä–∞ –ø—Ä–æ –ö–µ–Ω–∞",
  "start_url": "/",
  "display": "standalone",
  "orientation": "landscape",
  "background_color": "#000000",
  "theme_color": "#000000",
  "icons": [
    {
      "src": "icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
};

// –°–æ–∑–¥–∞–µ–º manifest –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
document.querySelector('link[rel="manifest"]').href = manifestURL;

// ===== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====
let touchId = null;
let touchStartX = 0;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// ===== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ü–†–ï–ñ–ù–ò–ú =====
let images = {}, SOUNDS = {}, missing = [];
let page = 1;
let showOops = false, showOops2 = false;
let audioEnabled = false;
let kittyMusic = null;

const ken = { x:50, y:0, w:200, h:200, vx:6, action:'idle', animTimer:0, facing:'right' };

const enemies = {
  level2: { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 },
  level3: [
    { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 },
    { x:0, y:0, w:200, h:200, hp:5, alive:true, animTimer:0, action:'idle', hitTimer:0 }
  ]
};
const girl = { x:0, y:0, w:220, h:200 };

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const oopsBtn = document.getElementById('oopsBtn');
const mobileControls = document.getElementById('mobileControls');
const installPrompt = document.getElementById('installPrompt');

// ===== –ú–û–ë–ò–õ–¨–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï =====
function setupMobileControls() {
  if (!isMobile) return;
  
  mobileControls.style.display = 'flex';
  
  // –ö–Ω–æ–ø–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const attackBtn = document.getElementById('attackBtn');
  
  const handlePress = (btn, key) => {
    const press = () => keys[key] = true;
    const release = () => keys[key] = false;
    
    btn.addEventListener('touchstart', press);
    btn.addEventListener('touchend', release);
    btn.addEventListener('touchcancel', release);
  };
  
  handlePress(leftBtn, 'ArrowLeft');
  handlePress(rightBtn, 'ArrowRight');
  
  // –ö–Ω–æ–ø–∫–∞ –∞—Ç–∞–∫–∏
  attackBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    keys['Space'] = true;
    handleAction();
  });
  
  attackBtn.addEventListener('touchend', () => {
    keys['Space'] = false;
  });
  
  // –°–≤–∞–π–ø—ã –ø–æ —ç–∫—Ä–∞–Ω—É
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    if (touchId === null) {
      touchId = e.touches[0].identifier;
      touchStartX = e.touches[0].clientX;
    }
  });
  
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!touchId) return;
    
    const touch = Array.from(e.touches).find(t => t.identifier === touchId);
    if (!touch) return;
    
    const diffX = touch.clientX - touchStartX;
    if (Math.abs(diffX) > 10) {
      keys['ArrowLeft'] = diffX < 0;
      keys['ArrowRight'] = diffX > 0;
      touchStartX = touch.clientX;
    }
  });
  
  canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    if (Array.from(e.changedTouches).some(t => t.identifier === touchId)) {
      touchId = null;
      keys['ArrowLeft'] = false;
      keys['ArrowRight'] = false;
    }
  });
}

// ===== PWA –£–°–¢–ê–ù–û–í–ö–ê =====
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installPrompt.style.display = 'block';
  
  setTimeout(() => {
    installPrompt.style.display = 'none';
  }, 5000);
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ
if (isMobile && window.matchMedia('(display-mode: browser)').matches) {
  setTimeout(() => {
    installPrompt.style.display = 'block';
  }, 10000);
}

// ===== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (–∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É) =====
function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  placeEntities();
  
  // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤–∫–ª—é—á–∞–µ–º –∞–ª—å–±–æ–º–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
  if (isMobile && window.innerHeight > window.innerWidth) {
    overlay.innerHTML = 'üì± –ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ!';
    overlay.style.background = 'rgba(200,100,0,0.9)';
  }
}
window.addEventListener('resize', resize);
resize();

function placeEntities(){
  const ground = canvas.height - ken.h - 20;
  ken.y = ground;
  enemies.level2.x = Math.max(300, canvas.width - 400); enemies.level2.y = ground;
  enemies.level3[0].x = Math.max(200, canvas.width - 800); enemies.level3[0].y = ground;
  enemies.level3[1].x = Math.max(300, canvas.width - 400); enemies.level3[1].y = ground;
  girl.x = canvas.width - 280; girl.y = ground;
}

function isColliding(a,b){
  return !(a.x + a.w < b.x  a.x > b.x + b.w  a.y + a.h < b.y || a.y > b.y + b.h);
}

function drawPlaceholder(x,y,w,h,label){
  ctx.fillStyle='#222'; ctx.fillRect(x,y,w,h);
  ctx.strokeStyle='#555'; ctx.strokeRect(x+1,y+1,w-2,h-2);
  ctx.fillStyle='#fff'; ctx.font='14px monospace'; ctx.fillText(label, x+6, y+18);
}

function drawKen(){
  const idleSet = [images.idle, images.idle1].filter(Boolean);
  const walkSet = [images.walk1, images.walk2].filter(Boolean);
  const punchImg = images.punch || null;
  let img = null;
  if(ken.action === 'walk' && walkSet.length) img = walkSet[Math.floor(ken.animTimer/10) % walkSet.length];
  else if(ken.action === 'punch' && punchImg) img = punchImg;
  else if(idleSet.length) img = idleSet[Math.floor(ken.animTimer/20) % idleSet.length];

  if(!img){ drawPlaceholder(ken.x, ken.y, ken.w, ken.h, 'Ken'); return; }

  ctx.save();
  if(ken.facing === 'left'){ ctx.scale(-1,1); ctx.drawImage(img, -ken.x - ken.w, ken.y, ken.w, ken.h); }
  else ctx.drawImage(img, ken.x, ken.y, ken.w, ken.h);
  ctx.restore();
}

function drawEnemy(en){
  if(!en.alive) return;
  const set = (en.action === 'punch') ? [images.mushpunch].filter(Boolean) : [images.mushidle1, images.mushidle2].filter(Boolean);
  if(set.length === 0){ drawPlaceholder(en.x, en.y, en.w, en.h, 'Mush'); return; }
  const img = set[Math.floor(en.animTimer/12) % set.length];
  if(img) ctx.drawImage(img, en.x, en.y, en.w, en.h);
}

function drawDeathPuffs(){
  if(page === 2 && !enemies.level2.alive && images.mushdeath){
    ctx.drawImage(images.mushdeath, enemies.level2.x, enemies.level2.y, enemies.level2.w, enemies.level2.h);
  }
  if(page === 3){
    enemies.level3.forEach(en=>{
      if(!en.alive && images.mushdeath){
        ctx.drawImage(images.mushdeath, en.x, en.y, en.w, en.h);
      }
    });
  }
}

function drawGirl(){
  const frames = [images.girl1, images.girl2, images.girl3].filter(Boolean);
  if(frames.length === 0){ drawPlaceholder(girl.x, girl.y, girl.w, girl.h, 'Girl'); return; }
  const img = frames[Math.floor(Date.now()/400) % frames.length];
  ctx.drawImage(img, girl.x, girl.y, girl.w, girl.h);
}

const IMAGES = {
  back1:'back1.jpg', back2:'back2.jpg', back3:'back3.jpg', back4:'back4.jpg',
  idle:'idle.png', idle1:'idle1.png', walk1:'walk1.png', walk2:'walk2.png', punch:'punch.png',
  mushidle1:'mushidle1.png', mushidle2:'mushidle2.png', mushpunch:'mushpunch.png', mushdeath:'mushdeath.png',
  girl1:'girl1.png', girl2:'girl2.png', girl3:'girl3.png',
  oops:'oops.jpg', oops2:'oops2.jpg'
};

function createSound(frequency, duration, type = 'sine') {
  if (!audioEnabled) return;
  
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = type;
    oscillator.frequency.value = frequency;
    gainNode.gain.setValueAtTime(0.7, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + duration);
  } catch (e) {
    console.log('Audio error:', e);
  }
}

function playSound(soundName) {
  if (!audioEnabled) return;
  
  switch(soundName) {
    case 'punch':
      createSound(150, 0.1, 'square');
      break;
    case 'hit':
      createSound(300, 0.2, 'sawtooth');
      break;
    case 'death':
      createSound(200, 0.5, 'sine');
      break;
    case 'fail':
      createSound(100, 0.3, 'square');
      break;
    case 'kitty':
      createSound(400, 0.8, 'sine');
      break;
    case 'whiff':
      createSound(80, 0.15, 'triangle');
      break;
  }
}

function playKittyMusic() {
  if (!audioEnabled || !kittyMusic) return;
  
  try {
    kittyMusic.currentTime = 0;

kittyMusic.volume = 0.7;
    kittyMusic.loop = true;
    const playPromise = kittyMusic.play();
    
    if (playPromise !== undefined) {
      playPromise.catch(error => {
        console.log('Music play failed:', error);
      });
    }
  } catch (e) {
    console.log('Music error:', e);
  }
}

function stopKittyMusic() {
  if (kittyMusic) {
    kittyMusic.pause();
    kittyMusic.currentTime = 0;
  }
}

function loadImage(key, src){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>{ images[key] = img; res({ok:true,key}); };
    img.onerror = ()=>{ images[key] = null; missing.push(src); res({ok:false,key}); };
    img.src = src;
  });
}

async function preloadAll(){
  overlay.textContent = '–ó–∞–≥—Ä—É–∂–∞—é —Ä–µ—Å—É—Ä—Å—ã...';
  missing = [];
  images = {};
  
  kittyMusic = new Audio('kitty.mp3');
  kittyMusic.preload = 'auto';
  
  const imagePromises = Object.entries(IMAGES).map(([k,s])=>loadImage(k,s));
  await Promise.all(imagePromises);
  
  if(missing.length) {
    overlay.textContent = '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: ' + missing.join(', ');
  } else {
    overlay.textContent = '–ö–æ—Å–Ω–∏—Å—å —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –∑–≤—É–∫–∞';
  }
}

function enableAudio() {
  if (audioEnabled) return;
  audioEnabled = true;
  overlay.style.display = 'none';
  playSound('hit');
}

canvas.addEventListener('click', enableAudio, { once: true });
window.addEventListener('keydown', enableAudio, { once: true });

const keys = {};
let lastPunchTime = 0;
const punchCooldown = 180;

window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){
    e.preventDefault();
    if(e.repeat) return;
    keys['Space'] = true;
    handleAction();
    return;
  }
  if(e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys[e.code] = true;
});
window.addEventListener('keyup', (e)=>{
  if(e.code === 'Space') keys['Space'] = false;
  if(e.code === 'ArrowLeft' || e.code === 'ArrowRight') keys[e.code] = false;
});

function attackHitbox(){
  const range = 90;
  const verticalInset = 30;
  const hb = { x:0,y:ken.y+verticalInset, w:range, h: ken.h - verticalInset*1.5 };
  if(ken.facing === 'right'){
    hb.x = ken.x + ken.w - 30;
  } else {
    hb.x = ken.x - range + 30;
  }
  return hb;
}

function nearGirl(){ return isColliding(ken, girl); }

function handleAction(){
  enableAudio();
  if(showOops || showOops2) return;
  if(Date.now() - lastPunchTime < punchCooldown) return;
  lastPunchTime = Date.now();

  if(page === 4 && nearGirl()){
    showOops = true;
    playSound('fail');
    oopsBtn.style.display = 'block';
    return;
  }

  ken.action = 'punch';
  let hit = false;
  const hb = attackHitbox();

  if(page === 2){
    const en = enemies.level2;
    if(en.alive && isColliding(hb, en)){
      en.hp -= 1; hit = true; en.action = 'punch'; en.hitTimer = 18;
      playSound('hit');
      if(en.hp <= 0) {
        en.alive = false;
        playSound('death');
      }
    }
  }
  if(page === 3){
    for(const en of enemies.level3){
      if(en.alive && isColliding(hb, en)){
        en.hp -= 1; hit = true; en.action = 'punch'; en.hitTimer = 18;
        playSound('hit');
        if(en.hp <= 0) {
          en.alive = false;
          playSound('death');
        }
      }
    }
  }

  if(!hit) playSound('whiff');

  setTimeout(()=>{ if(ken.action === 'punch') ken.action = 'idle'; }, 260);
}

oopsBtn.addEventListener('click', ()=>{
  showOops = false;
  showOops2 = true;
  oopsBtn.style.display = 'none';
  playSound('kitty');
  playKittyMusic();
});

function update(){
  if(!showOops && !showOops2){
    if(keys['ArrowRight']){ ken.x += ken.vx; ken.action = 'walk'; ken.facing = 'right'; }
    else if(keys['ArrowLeft']){ ken.x -= ken.vx; ken.action = 'walk'; ken.facing = 'left'; }
    else if(ken.action !== 'punch') ken.action = 'idle';
  }

  ken.x = Math.max(0, Math.min(canvas.width - ken.w, ken.x));
  ken.animTimer++;

  if(enemies.level2.hitTimer > 0){ enemies.level2.hitTimer--; if(enemies.level2.hitTimer === 0) enemies.level2.action = 'idle'; }
  enemies.level3.forEach(en => { if(en.hitTimer > 0){ en.hitTimer--; if(en.hitTimer === 0) en.action = 'idle'; } });

if(page===1 && ken.x >= canvas.width - ken.w - 10){ page = 2; ken.x = 40; }
  else if(page===2 && ken.x >= canvas.width - ken.w - 10 && !enemies.level2.alive){ page = 3; ken.x = 40; }
  else if(page===3 && ken.x >= canvas.width - ken.w - 10){ page = 4; ken.x = 40; }

  if(!showOops2) {
    stopKittyMusic();
  }
}

function render(){
  const bg = (page===1)?images.back1:(page===2)?images.back2:(page===3)?images.back3:images.back4;
  if(bg) ctx.drawImage(bg,0,0,canvas.width,canvas.height);
  else { ctx.fillStyle='#111'; ctx.fillRect(0,0,canvas.width,canvas.height); }

  drawDeathPuffs();

  if(page===2) drawEnemy(enemies.level2);
  if(page===3) enemies.level3.forEach(en => drawEnemy(en));
  if(page===4) drawGirl();

  drawKen();

  ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(8,8,160,34);
  ctx.fillStyle='#fff'; ctx.font='16px monospace'; ctx.fillText('–£—Ä–æ–≤–µ–Ω—å: ' + page, 14, 30);

  if(page===4 && !showOops && !showOops2 && nearGirl()){
    ctx.fillStyle='yellow'; ctx.font='20px monospace';
    ctx.fillText('–ù–∞–∂–º–∏ SPACE', canvas.width - 300, canvas.height - 260);
  }

  if(showOops){
    if(images.oops) {
      const width = canvas.width * 0.8;
      const height = width * 0.6;
      ctx.drawImage(images.oops, (canvas.width - width)/2, (canvas.height - height)/2, width, height);
    }
    else drawPlaceholder(canvas.width/2 - 200, canvas.height/2 - 150, 400, 300, 'oops');
  }
  if(showOops2){
    if(images.oops2) {
      const width = canvas.width * 0.7;
      const height = width * 0.6;
      ctx.drawImage(images.oops2, (canvas.width - width)/2, (canvas.height - height)/2, width, height);
    }
    else drawPlaceholder(canvas.width/2 - 200, canvas.height/2 - 150, 400, 300, 'oops2');
  }
}

function loop(){
  try{
    update(); render();
    requestAnimationFrame(loop);
  }catch(err){
    overlay.style.display='block';
    overlay.style.background='rgba(128,0,0,0.9)';
    overlay.textContent = 'Runtime error: ' + (err && err.message ? err.message : err);
    console.error(err);
  }
}

// ===== –ó–ê–ü–£–°–ö =====
preloadAll().then(()=>{
  placeEntities();
  setupMobileControls(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  loop();
}).catch(e=>{
  overlay.style.display='block';
  overlay.textContent='–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: '+e;
  console.error(e);
});

window.addEventListener('error', (e) => {
  overlay.style.display = 'block';
  overlay.style.background = 'rgba(128,0,0,0.9)';
  overlay.textContent = 'Error: ' + (e && e.message ? e.message : e);
  console.error(e.error || e.message);
});
</script>
</body>
</html>
