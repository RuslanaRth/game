/* ------------- Обновление состояния ------------- */
function update() {
  if (keys['ArrowRight']) {
    ken.x += ken.vx;
    ken.action = 'walk';
  } else if (keys['ArrowLeft']) {
    ken.x -= ken.vx;
    ken.action = 'walk';
  } else {
    if (ken.action !== 'punch') ken.action = 'idle';
  }

  ken.x = Math.max(0, Math.min(canvas.width - ken.w, ken.x));

  if (keys['Space']) {
    if (ken.action !== 'punch') {
      ken.action = 'punch';
      if (page === 2 && mush.alive && isColliding(ken, mush)) {
        mush.hp -= 1;
        mush.action = 'punch';
        if (mush.hp <= 0) {
          mush.alive = false;
          mush.action = 'death';
        } else {
          setTimeout(()=>{ if(mush.alive) mush.action = 'idle'; }, 250);
        }
      }
      setTimeout(()=>{ if(ken.action === 'punch') ken.action = 'idle'; }, 220);
    }
    keys['Space'] = false;
  }

  if (page === 1 && ken.x >= canvas.width - ken.w - 10) {
    page = 2;
    ken.x = 40;
    mush.x = canvas.width - 250; mush.hp = 3; mush.alive = true; mush.action = 'idle';
  }
}

/* ------------- Рендер сцены ------------- */
function render() {
  const bg = (page === 1) ? images.back1 : images.back2;
  if (bg) ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  ctx.fillStyle = '#fff'; ctx.font = '16px monospace';
  ctx.fillText('Уровень: ' + page, 12, 26);

  drawKen();
  if (page === 2) drawMush();
}

/* ------------- Игровой цикл ------------- */
function loop() {
  update();
  render();
  requestAnimationFrame(loop);
}

/* ------------- Старт ------------- */
preloadAll().then(() => {
  overlay.style.display = 'none';
  loop();
});
</script>
</body>
</html>
